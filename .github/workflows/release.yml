name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  create-release:
    permissions:
      contents: write
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: 'x64'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        id: tauri-build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Toolbox ${{ github.ref_name }}'
          releaseBody: 'See the assets to download this version and install.'
          releaseDraft: false
          prerelease: false
          includeUpdaterJson: true
          projectPath: .
          updaterJsonPath: latest.json
      
      - name: Find and upload latest.json
        if: always()
        shell: pwsh
        run: |
          $jsonPath = $null
          $possiblePaths = @(
            "latest.json",
            "src-tauri\target\release\bundle\nsis\latest.json",
            "src-tauri\target\release\bundle\msi\latest.json",
            "src-tauri\target\release\latest.json"
          )
          
          Write-Host "Searching for latest.json..."
          foreach ($path in $possiblePaths) {
            if (Test-Path $path) {
              Write-Host "Found latest.json at: $path"
              $jsonPath = $path
              break
            }
          }
          
          if (-not $jsonPath) {
            Write-Host "latest.json not found in standard paths. Searching recursively..."
            $found = Get-ChildItem -Path "." -Recurse -Filter "latest.json" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($found) {
              $jsonPath = $found.FullName
              Write-Host "Found latest.json at: $jsonPath"
            }
          }
          
          if ($jsonPath) {
            Write-Host "Content of latest.json:"
            Get-Content "$jsonPath" | Write-Host
            
            Write-Host "Uploading latest.json to release..."
            gh release upload "${{ github.ref_name }}" "$jsonPath" --repo "${{ github.repository }}" --clobber
            Write-Host "Successfully uploaded latest.json"
          } else {
            Write-Host "WARNING: latest.json not found!"
            Write-Host "tauri-action should create it automatically with includeUpdaterJson: true"
            Write-Host "Checking if it was uploaded by tauri-action..."
            
            # Проверяем, может быть он уже загружен в релиз
            $releaseAssets = gh release view "${{ github.ref_name }}" --repo "${{ github.repository }}" --json assets -q '.assets[].name' 2>$null
            if ($releaseAssets -contains "latest.json") {
              Write-Host "latest.json already exists in release, skipping upload"
            } else {
              Write-Host "ERROR: latest.json not found and not in release!"
              Write-Host "Make sure TAURI_PRIVATE_KEY is set and tauri-action can sign the update"
              exit 1
            }
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}